# Query Expansion Explanation

## Dependencies

This project depends on several packages, including:

- [pylucene-10.0.0](https://dlcdn.apache.org/lucene/pylucene/)
- [pytrec_eval](https://github.com/cvangysel/pytrec_eval)
- tqdm (for progress bars)

[Steps to install PyLucene10](https://mrishu.github.io/blog/2025/installing-pylucene10/)

To install the necessary dependencies, run:

```bash
pip install pytrec_eval tqdm scipy numpy matplotlib
```

Additionally, GNU `parallel` is required, which is available in the standard repositories of most Linux distributions.

## Preliminary Results

For queries generated by `iqg.py`, the `trec_eval` results are as follows:

_(Results are for the ideal query generated from the complete ground truth.)_

```
runid                  all ideal_query
num_q                  all 249
num_ret                all 249000
num_rel                all 17412
num_rel_ret            all 16213
map                    all 0.8919
gm_map                 all 0.8817
Rprec                  all 0.8511
bpref                  all 0.8955
recip_rank             all 1.0000
iprec_at_recall_0.00   all 1.0000
iprec_at_recall_0.10   all 0.9985
iprec_at_recall_0.20   all 0.9957
iprec_at_recall_0.30   all 0.9900
iprec_at_recall_0.40   all 0.9789
iprec_at_recall_0.50   all 0.9564
iprec_at_recall_0.60   all 0.9293
iprec_at_recall_0.70   all 0.8905
iprec_at_recall_0.80   all 0.8262
iprec_at_recall_0.90   all 0.6921
iprec_at_recall_1.00   all 0.3817
P_5                    all 0.9912
P_10                   all 0.9643
P_15                   all 0.9266
P_20                   all 0.8855
P_30                   all 0.8100
P_100                  all 0.4510
P_200                  all 0.2718
P_500                  all 0.1236
P_1000                 all 0.0651
```

---

# Steps to Reproduce for Restricted Ground Truth

These steps describe how to generate a restricted ground truth using only the relevance of documents that appear in the top 1000 retrieved documents.

### 1. Download and Extract the Dataset

Download the dataset from the provided link, extract it, and move it to a directory named `collections`:

```bash
mkdir -p collections
tar -xvzf trec678rb.tar.gz
mv trec678rb collections
```

### 2. Index the Dataset

```bash
python3 indexer_trec678rb.py
```

This will create an index in `indexed/trec678rb`.

### 3. Generate a `run` File for the Top 1000 BM25 Retrieval Results

```bash
python3 searcher.py
```

This will generate the `run` file at `test-runs/bm25.run`.

### 4. Intersect the `run` File with the Original `qrel` File

```bash
python3 intersect_run_with_qrel.py test-runs/bm25.run qrels/trec678rb.qrel qrels/bm25_intersect_trec678rb.qrel
```

This produces a restricted `qrel` file: `qrels/bm25_intersect_trec678rb.qrel`.

**NOTE**: In `iqg.py`, `restrict_qrel_path` can be modified to point to the restricted `qrel` file.

---

## Ideal Queries

### Generating Ideal Queries

- For generating ideal query on restricted ground truth, in the `__main__` section of `iqg.py`, make
  sure that the `restrict_qrel_path` is set to the restricted `qrel` file.
- For generating ideal query on the complete ground truth, in the `__main__` section of `iqg.py`, make
  sure that `restrict_qrel_path` is set to `None`.

#### Method 1: Without Parallelization (Clean Output)

```bash
python3 iqg.py extracted-queries/trec678 --runid ideal_query_restrict
```

This produces:

- `ideal-queries/trec678/runs/ideal_query_restrict.run`
- `ideal-queries/trec678/weights/ideal_query_restrict.term_weights`

#### Method 2: With Parallelization

```bash
./parallel_ideal_query_computer <number_of_jobs>
```

_(Default: 12 parallel jobs)_

Merge the split files into a single `run` and `term_weights` file:

```bash
cat ideal-queries/trec678/runs/ideal_query_restrict-split/* > ideal-queries/trec678/runs/ideal_query_restrict.run
```

```bash
cat ideal-queries/trec678/weights/ideal_query_restrict-split/* > ideal-queries/trec678/weights/ideal_query_restrict.term_weights
```

---

Generate the `ap` file:

```bash
mkdir -p ideal-queries/trec678/aps/
trec_eval -m map -q qrels/trec678rb.qrel ideal-queries/trec678/runs/ideal_query_restrict.run > ideal-queries/trec678/aps/ideal_query_restrict.ap
```

---

## Expanded Queries

[Download Expanded Queries](https://drive.google.com/file/d/1--By6ottQYm9qmV6yP7RQd4ik9Jv60RK/view?usp=drive_link)

### Generating `run` and `ap` Files

Expanded query weights were taken provided by Sourav Da ([expanded-queries-weights-only](https://drive.google.com/file/d/1PutRi-rUFQ0a4QfJ157lfHK1VXOmf3hk/view?usp=sharing)) and `run` and `ap` files were generated using `run_ap_generator.py`.

Parallel computation can be done using:

```bash
./parallel_run_ap_generator <number_of_jobs>
```

_(Default: 12 parallel jobs)_

---

## Computing Similarity and Correlation

Change the `ideal_q_runid` in `compute-correlation.py` to the runid of the ideal query which is to be considered.

```bash
python3 compute-correlation.py
```

---

# Results

## `jaccard` Similarity

| Correlation | Vanilla Ideal Query | Restricted Ideal Query |
| ----------- | ------------------- | ---------------------- |
| Pearson     | 0.32850289256426674 | 0.27759558828116154    |
| Kendall     | 0.2526529360617039  | 0.22540525530980843    |
| Spearman    | 0.33340652354355166 | 0.2938914619937353     |

## `l1` similarity

| Correlation | Vanilla Ideal Query  | Restricted Ideal Query |
| ----------- | -------------------- | ---------------------- |
| Pearson     | -0.21007223132213704 | -0.20728311608399294   |
| Kendall     | -0.16435169335619965 | -0.1601046472361515    |
| Spearman    | -0.20797697840523988 | -0.20506635517473298   |

## `l2` similarity

| Correlation | Vanilla Ideal Query | Restricted Ideal Query |
| ----------- | ------------------- | ---------------------- |
| Pearson     | 0.48588925313369746 | 0.42462301968902255    |
| Kendall     | 0.3762342288372392  | 0.33027383292111384    |
| Spearman    | 0.47650906178783736 | 0.4182856179869354     |

## `ndcg_modified_2` similarity

| Correlation | Vanilla Ideal Query  | Restricted Ideal Query |
| ----------- | -------------------- | ---------------------- |
| Pearson     | 0.06415343859352021  | 0.04582163064420157    |
| Kendall     | 0.046892955913689124 | 0.03735461453626145    |
| Spearman    | 0.07066278962536988  | 0.055134640052953016   |

## Generating Logistic Regression Ideal Queries

Just run:

```bash
python3 iqg2.py
```
